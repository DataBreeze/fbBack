<?php

/**
 * WikiCacheTable
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class WikiCacheTable extends Doctrine_Table{

  public static function getInstance(){
    return Doctrine_Core::getTable('WikiCache');
  }
  
  public function newRec($p){
    $wiki = new WikiCache();
    $wiki->setTitle($p['title']);
    $wiki->setContent($p['content']);
    $wiki->setDateTime(new Doctrine_Expression('NOW()'));    
    $wiki->save();
    $wiki_id = $wiki->getId();
    $new_wiki = $this->getRec($wiki_id);
    return $new_wiki;
  }
  
  public function update($p){
    if($wiki = $this->find($p['id'])){
      $wiki->setContent($p['content']);
      $wiki->setDateTime(new Doctrine_Expression('NOW()'));    
      $wiki->save();
      $new_wiki = $this->getRec($p['id']);
      return $new_wiki;
    }
    return False;
  }

  public function getRec($id){
    $q = Doctrine_Query::create()
      ->select('w.id,w.title,w.content,w.date_time,IF( (DATE_ADD(w.date_time,INTERVAL 30 DAY) < NOW()),1,0) AS expired')
      ->from('WikiCache w')
      ->where('w.id = ?',$id);
    $rows = $q->execute(array(),Doctrine_Core::HYDRATE_SCALAR);
    if($rows and ($row = $rows[0]) ){
      $rec = array();
      $rec['id'] = intval($row['w_id']);
      $rec['title'] = $row['w_title'];
      $rec['content'] = $row['w_content'];
      $rec['date_time'] = $row['w_date_time'];
      $rec['expired'] = $row['w_expired'];
      return $rec;
    }
    return False;
  }
  
  public function getByTitle($title){
    $q = Doctrine_Query::create()
      ->select('w.id,w.title,w.content,w.date_time,IF( (DATE_ADD(w.date_time,INTERVAL 30 DAY) < NOW()),1,0) AS expired')
      ->from('WikiCache w')
      ->where('w.title = ?',$title);
    $rows = $q->execute(array(),Doctrine_Core::HYDRATE_SCALAR);
    if($rows and ($row = $rows[0]) ){
      $rec = array();
      $rec['id'] = intval($row['w_id']);
      $rec['title'] = $row['w_title'];
      $rec['content'] = $row['w_content'];
      $rec['date_time'] = $row['w_date_time'];
      $rec['expired'] = $row['w_expired'];
      return $rec;
    }
    return False;
  }
  
}