<?php

/**
 * UserNotifyTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class UserNotifyTable extends Doctrine_Table{
  public static function getInstance(){
    return Doctrine_Core::getTable('UserNotify');
  }

  public function addNotify($param){
    $mtype = ($param['mtype'] ? $param['mtype'] : 10);
    $notify = new UserNotify();
    $notify->setUserId($param['user_for_id']);
    $notify->setFromUserId($param['user_from_id']);
    $notify->setCaption($param['caption']);
    $notify->setContent($param['content']);
    $notify->setMtype($param['mtype']);
    $notify->setDateCreate(new Doctrine_Expression('NOW()'));
    if($param['url']){
      $notify->setUrl($param['url']);
    }
    $notify->save();
  }

  public function updateNotifyStatus($notify_id,$status = 100){
    if($notify = $this->find($notify_id)){
      $notify->setStatus(intval($status));
      $notify->save();
      return True;
    }
    return False;
  }
  
  public function getNotify($notify_id){
    $q = Doctrine_Query::create()
      ->select('u.username,n.id,n.user_id,n.from_user_id,n.caption,n.content,n.mtype,DATE_FORMAT(n.date_create,\'%c/%e/%y\') AS date_create,n.url')
      ->from('UserNotify n')
      ->innerJoin('n.User u')
      ->where('n.id = ?',$notify_id);
    $rows = $q->execute(array(),Doctrine_Core::HYDRATE_SCALAR);
    if(count($rows) > 0 ){
      if($row = $rows[0]){
	$rec = array();
	$rec['id'] = intval($row['n_id']);
	$rec['user_id'] = intval($row['n_user_id']);
	$rec['date_create'] = $row['n_date_create'];
	$rec['caption'] = $row['n_caption'];
	$rec['content'] = $row['n_content'];
	$rec['status'] = intval($row['n_status']);
	$rec['mtype'] = intval($row['n_mtype']);
	$rec['username'] = $row['u_username'];
	$rec['from_user_id'] = $row['n_from_user_id'];
	$rec['url'] = $row['n_url'];
	return $rec;
      }
    }
    return False;
  }

  public function getNotifies($user_id){
    $ret = array('count' => 0,'records' => array());
    if($user_id > 0){
      $q = Doctrine_Query::create()
	->select('u.username,n.id,n.user_id,n.from_user_id,n.caption,n.content,n.mtype,DATE_FORMAT(n.date_create,\'%c/%e/%y\') AS date_create,n.url')
	->from('UserNotify n')
	->innerJoin('n.User u')
	->where('n.user_id = ?',$user_id)
	->andWhereIn('n.status',array(1))
	->orderBy('n.date_create DESC');
      $rows = $q->execute(array(),Doctrine_Core::HYDRATE_SCALAR);
      if(count($rows) > 0 ){
	foreach($rows as $i => $row){
	  $recs[$i]['id'] = intval($row['n_id']);
	  $recs[$i]['user_id'] = intval($row['n_user_id']);
	  $recs[$i]['date_create'] = $row['n_date_create'];
	  $recs[$i]['caption'] = $row['n_caption'];
	  $recs[$i]['content'] = $row['n_content'];
	  $recs[$i]['status'] = intval($row['n_status']);
	  $recs[$i]['mtype'] = intval($row['n_mtype']);
	  $recs[$i]['url'] = $row['n_url'];
	  $recs[$i]['username'] = $row['u_username'];
	  if($from_user_id = $row['n_from_user_id']){
	    if($from_user = Doctrine_Core::getTable('User')->getUserById($from_user_id)){
	      $recs[$i]['username_from'] = $from_user['username'];
	    }
	  }
	}
	$ret['count'] = count($recs);
	$ret['records'] = $recs;
      }
    }
    return $ret;
  }
  
}